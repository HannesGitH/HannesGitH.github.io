<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phong Kugeln</title>
</head>
<body>
    <canvas id="main_canvas" width="600" height="600">

    </canvas>
    <p>move mouse to move lightsource, scroll to move lightsource back and forth</p>   
    <button id="order" onclick="order()">in Gitter anordnen</button> 
    <button id="transparency" onclick="transtog()">Toggle Transparency</button> 
    <div id="kugelinfo">Kugelinfo:</div>
</body>
<style>
    p{
        padding-top: 0.1cm;
    }
</style>
<script>
    class lichtquelle{
        constructor(x,y,z,i){
            this.x=x??100;
            this.y=y??100;
            this.z=z??100;
            this.i=i??1;
        }
    }
    class kreis{
        constructor(x,y,r){
            this.x=x??0;
            this.y=y??0;
            this.r=r??100;
            this.r2=this.r**2;
        }
        hasPixel(x,y){
            return (x-this.x)**2+(y-this.y)**2<=this.r2;
        }
    }
    class kugel{
        constructor(circle,k_ambient,k_diffus,k_specular,polishCoef){
            this.circle=circle??new kreis();
            this.k_ambient=k_ambient??0.5;
            this.k_diffus=k_diffus??0.5;
            this.k_specular=k_specular??0.5;
            this.polishCoef=polishCoef??32;
            this.normFactor=(this.polishCoef+2)/2*Math.PI;
        }
        _getZ(_x,_y){
            return Math.sqrt(this.circle.r**2-(_x)**2-(_y)**2);
        }
        _getDirectional(x,y){
            let _x=x-this.circle.x;
            let _y=y-this.circle.y;
            let _z=this._getZ(_x,_y);
            return [_x,_y,_z];
        }
        _getNormal(x,y){
            let d=this._getDirectional(x,y);
            let length=this.circle.r;//Math.sqrt([0]**2+d[1]**2+d[2]**2);
            return this.scalarMult3(d,1/length);
        }
        _getCoords(x,y){
            let z_ = this._getDirectional(x,y)[2];
            return [x,y,z_];
        }
        _getNormalLightDirection(x,y,l){
            let c=this._getCoords(x,y);
            var x_=c[0]-l.x;
            var y_=c[1]-l.y;
            var z_=c[2]-l.z;
            let length=Math.sqrt(x_**2+y_**2+z_**2);
            x_ /= length;
            y_ /= length;
            z_ /= length;
            return [x_,y_,z_];
        }
        scalarProd3(v1,v2){
            return v1[0]*v2[0]+v1[1]*v2[1]+v1[2]*v2[2];
        }
        scalarMult3(v,s){
            return [v[0]*s,v[1]*s,v[2]*s];
        }
        vectorSub3(v1,v2){
            return [v1[0]-v2[0],v1[1]-v2[1],v1[2]-v2[2]];
        }


        _getAmbLight(i_amb){
            return i_amb*this.k_ambient;
        }
        _getDiffLight(x,y,l){
            let v1=this._getNormal(x,y);
            let v2=this._getNormalLightDirection(x,y,l);
            let value = l.i*this.k_diffus*this.scalarProd3(v1,v2);

            if (value>0&&notTransparent)return 0;
            if(value>0) return Math.abs(value)*0.5;
            return Math.abs(value);
        }
        _getSpecLight(x,y,l){
            let v1=[0,0,-1]; //blickrichtung
            let toReflect=this._getNormalLightDirection(x,y,l);
            let normal=this._getNormal(x,y);
            let v2=this.vectorSub3(toReflect,this.scalarMult3(normal,this.scalarProd3(normal,toReflect)*2));//reflektionsrichtung
            let s = this.scalarProd3(v1,v2);
            let value = l.i*this.k_specular*this.normFactor*(s**this.polishCoef);

            if (s>0&&notTransparent)return 0;
            if(value>0) return Math.abs(value)/this.normFactor*0.5;
            return Math.abs(value);
        }

        getLightness(x,y,i_ambient, lichtquelle){
            let lightness=this._getAmbLight(i_ambient)+this._getDiffLight(x,y,lichtquelle)+this._getSpecLight(x,y,lichtquelle);
            return lightness>1?1:lightness; //prevent lightness over 1 which would make the kugel see-through 
        }
        hasPixel(x,y){return this.circle.hasPixel(x,y);}

        toInfoString(){
            return "Ambiente Leuchtstärke: "+this.k_ambient+"; Diffuse Leuchtstärke: "+this.k_diffus+"; Reflektierende Leuchtstärke: "+this.k_specular+"; Glattheitskoeffizient: "+this.polishCoef;
        }
    }


    function createScene(){
        l = new lichtquelle();

        function createRandomKugel(){
            let glattness=10+Math.round((Math.random()*10)**3);
            let k = new kugel(new kreis(Math.random()*c.clientWidth,Math.random()*c.clientHeight,Math.random()*40+15),Math.random()*0.2,Math.random()*1,Math.random()*1,glattness);
            
            let para = document.createElement("P");
            para.appendChild(document.createTextNode(k.toInfoString())); 
            document.getElementById("kugelinfo").appendChild(para); 
            kugelInfoHtml.appendChild(para);
            return k
        }

        kugelList = [];
        for(var index=0;index<20;index++){
            kugelList.push(createRandomKugel());
        }

        notTransparent=true;//whether the back of the kugel is ignored
    }

    function drawFrame(kugelList,lightsource){

        function calcKugelPixel(kugel){
            let z=kugel._getDirectional(x,y)[2];
            if(kugel.hasPixel(x,y)&&z>maxZ){ //dont make useless calculation if the kugel doesnt occupy this pixel
                maxZ=z;
                var a=255;
                r=g=b=kugel.getLightness(x,y,1,lightsource)*255;
                ctx.fillStyle="rgba("+r+","+g+","+b+","+(a/255)+")";
                ctx.fillRect( x, y, 1, 1 );
            }
        }

        ctx.fillStyle ="#000";
        ctx.fillRect(0,0,c.clientWidth,c.clientHeight);
        for(x=0;x<c.clientWidth;x++){
            for(y=0;y<c.clientHeight;y++){
                maxZ=0;
                kugelList.forEach(calcKugelPixel);
            }
        }
    }

    function transtog(){
        notTransparent^=true;
        drawFrame(kugelList,l);
    }
    function order(){
        let b=document.getElementById("order");
        b.hidden=true;
        for(let k=0;k<kugelList.length;k++){
            kugelList[k].circle.x=((k%5)+0.5)*c.clientHeight/5
            kugelList[k].circle.y=((k%4)+0.5)*c.clientWidth/4
        }
        drawFrame(kugelList,l);
    }

    var c = document.getElementById("main_canvas");
    var ctx = c.getContext("2d");

    let kugelInfoHtml = document.getElementById("kugelinfo");

    createScene();
    drawFrame(kugelList,l);

    c.addEventListener("mousemove",(e)=>{
        e.preventDefault;
        if(e.button==0){
            l.x=e.clientX;
            l.y=e.clientY;
        }
        drawFrame(kugelList,l);
    });
    c.addEventListener("wheel", event => {
        const delta = Math.sign(event.deltaY);
        l.z+=delta*10;
        drawFrame(kugelList,l);
    });
    c.addEventListener("contextmenu",(e)=>{event.preventDefault(); return false;});
    
</script>
</html>